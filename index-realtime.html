<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D/s Dynamic Contract - Real-time Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-dark: #8b0000;
            --primary-light: #dc143c;
            --accent-pink: #ff69b4;
            --accent-light-pink: #ffb6c1;
            --background: #1a0000;
            --text-light: #fff5f5;
            --border-gold: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: var(--background);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Authentication Screen */
        #auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #000 100%);
        }

        .auth-container {
            background: rgba(139, 0, 0, 0.3);
            border: 2px solid var(--border-gold);
            border-radius: 15px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .auth-container h1 {
            font-family: 'Cinzel', serif;
            text-align: center;
            color: var(--accent-pink);
            margin-bottom: 10px;
            font-size: 2em;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--accent-light-pink);
            margin-bottom: 30px;
            font-style: italic;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary-light);
            border-color: var(--border-gold);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.5);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent-pink);
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Crimson Text', serif;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-pink) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.5);
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(220, 20, 60, 0.2);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            color: var(--accent-light-pink);
            display: none;
        }

        .success-message {
            background: rgba(0, 128, 0, 0.2);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            color: #90ee90;
            display: none;
        }

        /* Main App Screen */
        #app-screen {
            display: none;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .app-header h1 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
            font-size: 1.8em;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .presence-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--accent-pink);
        }

        .presence-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 10px 20px;
            background: var(--primary-light);
            border: 1px solid var(--border-gold);
            border-radius: 8px;
            color: white;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn:hover {
            background: var(--accent-pink);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 105, 180, 0.2);
            border-color: var(--accent-pink);
        }

        /* Contract List */
        .contract-list-screen {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        .contract-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .contract-list-header h2 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
            font-size: 2em;
        }

        .contracts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .contract-card {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.3) 100%);
            border: 2px solid var(--primary-light);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .contract-card:hover {
            border-color: var(--accent-pink);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
        }

        .contract-card h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
            margin-bottom: 10px;
        }

        .contract-card .meta {
            color: var(--accent-light-pink);
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .contract-card .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .contract-card .btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        .shared-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-pink);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Contract Editor */
        .contract-editor {
            display: none;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .editor-title {
            flex: 1;
        }

        .editor-title input {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            color: var(--accent-pink);
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            font-weight: 700;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid var(--accent-pink);
            font-size: 0.9em;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
        }

        .sync-dot.syncing {
            background: #ffff00;
            animation: pulse 1s infinite;
        }

        .sync-dot.error {
            background: #ff0000;
        }

        /* Contract Sections */
        .contract-section {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.2) 100%);
            border: 2px solid var(--primary-light);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-pink);
            padding-bottom: 15px;
        }

        .section-header h2 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
            font-size: 1.8em;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .section-content {
            display: grid;
            gap: 20px;
        }

        /* Form Fields */
        .field-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .field-group label {
            color: var(--accent-pink);
            font-weight: 600;
            font-size: 1.1em;
        }

        .field-group input,
        .field-group textarea,
        .field-group select {
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Crimson Text', serif;
            font-size: 16px;
        }

        .field-group input:focus,
        .field-group textarea:focus,
        .field-group select:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
        }

        .field-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* List Items */
        .list-item {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--primary-light);
            transition: all 0.3s;
        }

        .list-item:hover {
            border-color: var(--accent-pink);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.2);
        }

        .list-item.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .drag-handle {
            cursor: grab;
            color: var(--accent-pink);
            font-size: 20px;
            margin-right: 8px;
            user-select: none;
            display: inline-block;
            vertical-align: middle;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .field-group {
            position: relative;
            padding-left: 35px;
        }

        /* List fields don't have parent bow, so no left padding */
        .field-group-list {
            padding-left: 0;
        }

        .field-group .drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .field-group.dragging {
            opacity: 0.5;
            background: rgba(255, 105, 180, 0.1);
        }

        .list-item {
            position: relative;
            padding-left: 35px;
        }

        .list-item .drag-handle {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .list-item.dragging {
            opacity: 0.5;
            background: rgba(255, 105, 180, 0.1);
        }

        .list-item input,
        .list-item textarea {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary-light);
            border-radius: 6px;
            padding: 10px;
            color: var(--text-light);
            font-family: 'Crimson Text', serif;
        }

        .remove-btn {
            background: rgba(220, 20, 60, 0.3);
            border: 1px solid var(--primary-light);
            color: var(--accent-light-pink);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .add-item-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 105, 180, 0.2);
            border: 1px dashed var(--accent-pink);
            border-radius: 8px;
            color: var(--accent-pink);
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .add-item-btn:hover {
            background: rgba(255, 105, 180, 0.3);
            border-style: solid;
        }

        /* History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #000 100%);
            border-left: 2px solid var(--border-gold);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.7);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            padding: 20px;
            background: rgba(139, 0, 0, 0.3);
            border-bottom: 2px solid var(--accent-pink);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-header h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
        }

        .history-timeline {
            padding: 20px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 20px;
            width: 10px;
            height: 10px;
            background: var(--accent-pink);
            border-radius: 50%;
        }

        .history-item .timestamp {
            color: var(--accent-light-pink);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .history-item .change {
            color: var(--text-light);
        }

        .history-item .user {
            color: var(--accent-pink);
            font-weight: 600;
        }

        /* Share Dialog */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.open {
            display: flex;
        }

        .dialog {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #000 100%);
            border: 2px solid var(--border-gold);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dialog h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-pink);
            margin-bottom: 20px;
        }

        .dialog-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .dialog-actions .btn {
            flex: 1;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .contracts-grid {
                grid-template-columns: 1fr;
            }

            .history-panel {
                width: 100%;
                right: -100%;
            }

            .editor-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .editor-title input {
                max-width: 100%;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 105, 180, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-pink);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Preview Modal */
        .preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            overflow-y: auto;
        }

        .preview-overlay.open {
            display: block;
        }

        .preview-container {
            max-width: 900px;
            margin: 40px auto;
            background:
                linear-gradient(135deg, rgba(20, 10, 10, 0.95), rgba(30, 15, 15, 0.98)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 0, 0, 0.02) 2px,
                    rgba(139, 0, 0, 0.02) 4px
                );
            border: 3px solid #8b0000;
            padding: 60px;
            box-shadow:
                0 0 0 1px rgba(255, 105, 180, 0.3),
                0 0 30px rgba(139, 0, 0, 0.6),
                inset 0 0 100px rgba(0, 0, 0, 0.8),
                0 20px 60px rgba(0, 0, 0, 0.5);
            min-height: calc(100vh - 80px);
            position: relative;
            border-radius: 5px;
        }

        /* Leather texture for preview */
        .preview-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 30% 40%, rgba(80, 40, 40, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(80, 40, 40, 0.15) 0%, transparent 50%);
            pointer-events: none;
            border-radius: 5px;
        }

        /* Pink bows for preview */
        .preview-bow {
            position: absolute;
            font-size: 60px;
            z-index: 10;
            filter: drop-shadow(3px 3px 10px rgba(255, 105, 180, 0.5));
            opacity: 0.9;
        }

        .preview-bow-top-left {
            top: -20px;
            left: -20px;
            transform: rotate(-15deg);
        }

        .preview-bow-top-right {
            top: -20px;
            right: -20px;
            transform: rotate(15deg);
        }

        .preview-bow-bottom-left {
            bottom: -20px;
            left: -20px;
            transform: rotate(15deg);
        }

        .preview-bow-bottom-right {
            bottom: -20px;
            right: -20px;
            transform: rotate(-15deg);
        }

        .preview-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-dark);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3001;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .preview-header h3 {
            color: var(--accent-pink);
            font-family: 'Cinzel', serif;
            margin: 0;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .preview-content {
            margin-top: 70px;
            color: #ffb6c1;
            font-family: 'Crimson Text', serif;
            line-height: 1.8;
            position: relative;
            z-index: 1;
        }

        .preview-content h1 {
            font-family: 'Cinzel', serif;
            font-size: 44px;
            font-weight: 700;
            background: linear-gradient(135deg, #8b0000, #ff69b4, #8b0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(255, 105, 180, 0.3);
        }

        .preview-content h2 {
            font-family: 'Cinzel', serif;
            font-size: 26px;
            color: #dc143c;
            margin-bottom: 20px;
            margin-top: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .preview-content h2::before {
            content: '🎀';
            font-size: 22px;
            filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.5));
        }

        .preview-content h2::after {
            content: '🎀';
            font-size: 22px;
            filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.5));
        }

        .preview-content h3 {
            font-family: 'Crimson Text', serif;
            font-size: 13px;
            color: #d4768f;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
            margin-top: 20px;
            display: block;
        }

        .preview-subtitle {
            text-align: center;
            color: #d4768f;
            font-size: 16px;
            font-style: italic;
            margin-top: 15px;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(139, 0, 0, 0.6);
            position: relative;
        }

        .preview-subtitle::after {
            content: '⛓️ 🎀 ⛓️';
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            background: linear-gradient(135deg, rgba(20, 10, 10, 0.95), rgba(30, 15, 15, 0.98));
            padding: 0 20px;
        }

        .preview-divider {
            text-align: center;
            font-size: 24px;
            margin: 35px 0;
            color: #ffb6c1;
            opacity: 0.8;
        }

        .preview-content p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .preview-content ul {
            list-style: none;
            padding-left: 0;
        }

        .preview-content li {
            margin-bottom: 12px;
            padding-left: 30px;
            position: relative;
        }

        .preview-content li::before {
            content: "🎀";
            position: absolute;
            left: 0;
            color: var(--accent-pink);
        }

        .preview-empty {
            color: rgba(255, 182, 193, 0.4);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .preview-date {
            text-align: center;
            color: #d4768f;
            font-style: italic;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid rgba(139, 0, 0, 0.6);
        }

        /* Terms Notice */
        .preview-terms-notice {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-left: 4px solid #8b0000;
            padding: 20px;
            margin: 30px 0;
            font-size: 16px;
            color: #d4768f;
            font-style: italic;
            line-height: 1.8;
            border-radius: 3px;
        }

        /* Signature Section */
        .preview-signature-section {
            margin-top: 50px;
            padding-top: 40px;
            border-top: 2px solid rgba(139, 0, 0, 0.6);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
        }

        .preview-signature-box {
            text-align: center;
            position: relative;
        }

        .preview-signature-box::before {
            content: '🎀';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            filter: drop-shadow(0 0 8px rgba(255, 105, 180, 0.6));
        }

        .preview-signature-box label {
            display: block;
            font-family: 'Cinzel', serif;
            font-size: 12px;
            color: #dc143c;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .preview-signature-value {
            width: 100%;
            border: none;
            border-bottom: 2px solid rgba(139, 0, 0, 0.6);
            background: transparent;
            font-family: 'Brush Script MT', 'Lucida Handwriting', cursive;
            font-size: 26px;
            color: #ff6b9d;
            text-align: center;
            padding: 10px 0;
            min-height: 40px;
        }

        .preview-signature-date {
            font-family: 'Crimson Text', serif;
            font-size: 14px;
            margin-top: 15px;
            color: #d4768f;
            text-align: center;
        }

        @media (max-width: 768px) {
            .preview-signature-section {
                grid-template-columns: 1fr;
                gap: 50px;
            }
        }

        /* Animations for Presence Notifications */
        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .editor-actions,
            .section-actions,
            .add-item-btn,
            .remove-btn,
            .history-panel,
            .dialog-overlay,
            .preview-header {
                display: none !important;
            }

            .preview-overlay {
                display: block !important;
                background: white !important;
            }

            .preview-container {
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
            }

            .preview-content {
                margin-top: 0 !important;
            }

            body {
                background: white;
                color: black;
            }

            .contract-section {
                page-break-inside: avoid;
                border-color: black;
            }

            .preview-content h2 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="auth-screen">
        <div class="auth-container">
            <h1>⛓️ D/s Dynamic Contract 🎀</h1>
            <p class="subtitle">Real-time collaborative edition</p>

            <div class="error-message" id="auth-error"></div>
            <div class="success-message" id="auth-success"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <button type="submit" class="auth-button">
                    <span class="btn-text">Login</span>
                    <span class="loading" style="display: none;"></span>
                </button>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="auth-form">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required placeholder="••••••••" minlength="6">
                </div>
                <div class="form-group">
                    <label for="signup-display-name">Display Name</label>
                    <input type="text" id="signup-display-name" required placeholder="Your name">
                </div>
                <button type="submit" class="auth-button">
                    <span class="btn-text">Create Account</span>
                    <span class="loading" style="display: none;"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen">
        <!-- Header -->
        <header class="app-header">
            <h1>⛓️ D/s Dynamic Contract 🎀</h1>
            <div class="header-controls">
                <div class="presence-indicator" id="presence-indicator" style="display: none;">
                    <span class="presence-dot"></span>
                    <span id="presence-text">You are online</span>
                </div>
                <button class="btn btn-secondary" id="user-menu-btn">
                    <span id="user-email"></span>
                </button>
                <button class="btn" id="logout-btn">Logout</button>
            </div>
        </header>

        <!-- Contract List View -->
        <div class="contract-list-screen" id="contract-list">
            <div class="contract-list-header">
                <h2>Your Contracts</h2>
                <button class="btn" id="create-contract-btn">+ Create New Contract</button>
            </div>
            <div class="contracts-grid" id="contracts-grid">
                <!-- Contracts will be loaded here -->
            </div>
        </div>

        <!-- Contract Editor View -->
        <div class="contract-editor" id="contract-editor">
            <div class="editor-header">
                <div class="editor-title">
                    <input type="text" id="contract-title" placeholder="Contract Title">
                </div>
                <div class="editor-actions">
                    <div class="sync-status">
                        <span class="sync-dot" id="sync-dot"></span>
                        <span id="sync-text">Synced</span>
                    </div>
                    <button class="btn" id="preview-btn">👁️ Preview</button>
                    <button class="btn btn-secondary" id="history-btn">📜 History</button>
                    <button class="btn btn-secondary" id="share-btn">🔗 Share</button>
                    <button class="btn" id="save-snapshot-btn">📸 Snapshot</button>
                    <button class="btn btn-secondary" id="back-to-list-btn">← Back</button>
                </div>
            </div>

            <!-- Contract Sections -->
            <div id="contract-sections">
                <!-- Sections will be dynamically loaded here -->
            </div>

            <button class="btn" id="add-section-btn" style="width: 100%; margin-top: 20px;">+ Add Section</button>

            <!-- Signature Section -->
            <div class="contract-section" style="margin-top: 50px; padding-top: 40px; border-top: 2px solid var(--border-color);">
                <h2 style="text-align: center; color: var(--accent-pink); margin-bottom: 30px;">Signatures</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div>
                        <label style="display: block; color: var(--accent-pink); margin-bottom: 10px; font-weight: 600;">Owner's Signature</label>
                        <input type="text" id="owner-signature" placeholder="Sign here" style="width: 100%; font-family: 'Brush Script MT', 'Lucida Handwriting', cursive; font-size: 24px; padding: 10px; border: none; border-bottom: 2px solid var(--border-color); background: transparent; color: var(--text-color);">
                        <input type="date" id="owner-signature-date" style="width: 100%; margin-top: 10px; padding: 8px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color);">
                    </div>
                    <div>
                        <label style="display: block; color: var(--accent-pink); margin-bottom: 10px; font-weight: 600;">Submissive's Acceptance</label>
                        <input type="text" id="submissive-signature" placeholder="Sign here" style="width: 100%; font-family: 'Brush Script MT', 'Lucida Handwriting', cursive; font-size: 24px; padding: 10px; border: none; border-bottom: 2px solid var(--border-color); background: transparent; color: var(--text-color);">
                        <input type="date" id="submissive-signature-date" style="width: 100%; margin-top: 10px; padding: 8px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color);">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <h3>Change History</h3>
            <button class="btn btn-secondary" id="close-history-btn">✕</button>
        </div>
        <div class="history-timeline" id="history-timeline">
            <!-- History items will be loaded here -->
        </div>
    </div>

    <!-- Share Dialog -->
    <div class="dialog-overlay" id="share-dialog">
        <div class="dialog">
            <h3>Share Contract</h3>

            <!-- Public Sharing Section -->
            <div class="form-group" style="background: rgba(139, 0, 0, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4 style="color: var(--accent-pink); margin: 0 0 10px;">🌐 Public Sharing (No Account Needed)</h4>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="public-share-toggle" style="cursor: pointer;">
                        <span>Enable public link</span>
                    </label>
                </div>
                <div id="public-link-container" style="display: none;">
                    <div class="form-group" style="margin: 10px 0;">
                        <label for="public-share-role">Public Link Permission</label>
                        <select id="public-share-role">
                            <option value="viewer">Viewer (read-only)</option>
                            <option value="editor">Editor (can edit)</option>
                        </select>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin: 10px 0;">Anyone with this link can access the contract:</p>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="public-link" readonly style="flex: 1; background: rgba(0,0,0,0.3); cursor: text;">
                        <button class="btn btn-secondary" id="copy-link-btn">📋 Copy</button>
                    </div>
                </div>
            </div>

            <!-- Email Sharing Section -->
            <h4 style="color: var(--accent-pink); margin: 0 0 10px;">📧 Share with Registered Users</h4>
            <div class="form-group">
                <label for="share-email">Partner's Email</label>
                <input type="email" id="share-email" placeholder="partner@email.com">
            </div>
            <div class="form-group">
                <label for="share-role">Role</label>
                <select id="share-role">
                    <option value="editor">Editor (can edit)</option>
                    <option value="viewer">Viewer (read-only)</option>
                </select>
            </div>
            <div id="current-shares">
                <h4 style="color: var(--accent-pink); margin: 20px 0 10px;">Current Shares:</h4>
                <div id="shares-list"></div>
            </div>
            <div class="dialog-actions">
                <button class="btn btn-secondary" id="cancel-share-btn">Cancel</button>
                <button class="btn" id="confirm-share-btn">Share</button>
            </div>
        </div>
    </div>

    <!-- Preview Overlay -->
    <div class="preview-overlay" id="preview-overlay">
        <div class="preview-header">
            <h3>📄 Contract Preview</h3>
            <div class="preview-actions">
                <!-- Presence indicator for viewers -->
                <div class="presence-indicator" id="preview-presence-indicator" style="margin-right: 15px;">
                    <span class="presence-dot"></span>
                    <span id="preview-presence-text">You are online</span>
                </div>
                <button class="btn btn-secondary" onclick="window.print()">🖨️ Print</button>
                <button class="btn" id="close-preview-btn">✕ Close</button>
            </div>
        </div>
        <div class="preview-container">
            <div class="preview-content" id="preview-content">
                <!-- Preview content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://sryxyqioytqxcmgtykao.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyeXh5cWlveXRxeGNtZ3R5a2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MzY4NjMsImV4cCI6MjA3NzQxMjg2M30.QJxb6sUEngf-KEheV9C1Wj14_dDADzuW7PrQtAUcqPo';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentUser = null;
        let currentContract = null;
        let realtimeChannel = null;
        let presenceChannel = null;
        let saveTimeout = null;
        let isSyncing = false;
        let pollingInterval = null;
        let usePolling = false;

        // ============================================
        // AUTHENTICATION
        // ============================================

        // Check for existing session on load
        async function checkAuth() {
            // Check if accessing via public share link
            const urlParams = new URLSearchParams(window.location.search);
            const publicToken = urlParams.get('share');

            if (publicToken) {
                // Public access mode - no login required
                await loadPublicContract(publicToken);
                return;
            }

            // Normal auth flow
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            } else {
                // No session - ensure auth screen is visible
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        }

        // Load contract via public share token
        async function loadPublicContract(token) {
            try {
                const { data, error } = await supabaseClient
                    .from('contracts')
                    .select('*')
                    .eq('public_share_token', token)
                    .eq('is_public', true)
                    .single();

                if (error || !data) {
                    alert('Invalid or expired share link');
                    window.location.href = window.location.pathname; // Remove token from URL
                    return;
                }

                // Set as current contract
                currentContract = data;
                const isEditor = data.public_share_role === 'editor';

                // Hide auth screen and show main app
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';

                if (isEditor) {
                    // Create a guest user for public editing
                    currentUser = {
                        id: 'public-editor',
                        email: 'public-editor@guest',
                        isPublicEditor: true
                    };

                    // Show contract editor (hide list view)
                    const contractList = document.getElementById('contract-list');
                    const contractEditor = document.getElementById('contract-editor');

                    if (contractList) contractList.style.display = 'none';
                    if (contractEditor) contractEditor.style.display = 'block';

                    // Set contract title
                    document.getElementById('contract-title').value = currentContract.title;

                    // Load signatures
                    document.getElementById('owner-signature').value = currentContract.owner_signature || '';
                    document.getElementById('owner-signature-date').value = currentContract.owner_signature_date || '';
                    document.getElementById('submissive-signature').value = currentContract.submissive_signature || '';
                    document.getElementById('submissive-signature-date').value = currentContract.submissive_signature_date || '';

                    // Hide buttons that shouldn't be available to public editors
                    const backBtn = document.getElementById('back-to-list-btn');
                    const shareBtn = document.getElementById('share-btn');
                    const historyBtn = document.getElementById('history-btn');
                    const snapshotBtn = document.getElementById('save-snapshot-btn');

                    if (backBtn) backBtn.style.display = 'none';
                    if (shareBtn) shareBtn.style.display = 'none';
                    if (historyBtn) historyBtn.style.display = 'none';
                    if (snapshotBtn) snapshotBtn.style.display = 'none';

                    renderContractEditor();
                    setupRealtimeSync();
                    setupPresence(); // Enable presence for public editors

                    // Add indicator that this is public editing
                    const editorActions = document.querySelector('.editor-actions');
                    if (editorActions) {
                        const indicator = document.createElement('div');
                        indicator.style.cssText = 'color: var(--accent-pink); font-size: 0.9em; font-weight: 600;';
                        indicator.textContent = '🌐 Public Editor Mode';
                        editorActions.insertBefore(indicator, editorActions.firstChild);
                    }
                } else {
                    // Viewers also get presence (but read-only)
                    currentUser = {
                        id: `viewer-${Date.now()}`,
                        email: 'public-viewer@guest',
                        isPublicViewer: true
                    };

                    // Show preview for viewers
                    renderPreview();
                    document.getElementById('preview-overlay').classList.add('open');
                    setupPresence(); // Enable presence for viewers too

                    // Add message to preview
                    const previewHeader = document.querySelector('.preview-header h3');
                    if (previewHeader) {
                        previewHeader.innerHTML = '📄 ' + (data.title || 'Contract Preview') + ' <span style="color: var(--accent-pink); font-size: 0.7em; margin-left: 10px;">(Shared View)</span>';
                    }
                }
            } catch (err) {
                console.error('Error loading public contract:', err);
                alert('Error loading shared contract');
            }
        }

        // Auth tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tabName}-form`).classList.add('active');
                hideAuthMessages();
            });
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            showAuthLoading(true);
            hideAuthMessages();

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                showAuthError(error.message);
            } else {
                currentUser = data.user;
                showApp();
            }

            showAuthLoading(false);
        });

        // Signup
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const displayName = document.getElementById('signup-display-name').value;

            showAuthLoading(true);
            hideAuthMessages();

            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        display_name: displayName
                    }
                }
            });

            if (error) {
                showAuthError(error.message);
            } else {
                showAuthSuccess('Account created! Please check your email to verify.');
            }

            showAuthLoading(false);
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                // Clean up realtime connections
                if (realtimeChannel) {
                    await supabaseClient.removeChannel(realtimeChannel);
                }
                if (presenceChannel) {
                    await supabaseClient.removeChannel(presenceChannel);
                }

                // Sign out from Supabase
                await supabaseClient.auth.signOut();

                // Clear current user state
                currentUser = null;
                currentContract = null;

                // Hide app screen and show auth screen
                document.getElementById('app-screen').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';

                // Reload the page to ensure clean state
                setTimeout(() => location.reload(), 100);
            } catch (error) {
                console.error('Error during logout:', error);
                // Force reload even if there's an error
                location.reload();
            }
        });

        // Helper functions for auth UI
        function showAuthLoading(show) {
            const btns = document.querySelectorAll('.auth-button');
            btns.forEach(btn => {
                btn.disabled = show;
                btn.querySelector('.btn-text').style.display = show ? 'none' : 'inline';
                btn.querySelector('.loading').style.display = show ? 'inline-block' : 'none';
            });
        }

        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            el.textContent = message;
            el.style.display = 'block';
        }

        function showAuthSuccess(message) {
            const el = document.getElementById('auth-success');
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideAuthMessages() {
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        }

        // ============================================
        // APP NAVIGATION
        // ============================================

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('user-email').textContent = currentUser.email;
            loadContracts();
            // Don't setup presence here - wait until a contract is opened
        }

        function showContractList() {
            document.getElementById('contract-list').style.display = 'block';
            document.getElementById('contract-editor').style.display = 'none';

            // Hide presence indicator when not viewing a contract
            const presenceIndicator = document.getElementById('presence-indicator');
            if (presenceIndicator) {
                presenceIndicator.style.display = 'none';
            }

            // Clean up presence channel
            if (presenceChannel) {
                supabaseClient.removeChannel(presenceChannel);
                presenceChannel = null;
            }

            // Remove presence UI elements
            const warningEl = document.getElementById('multi-editor-warning');
            const listEl = document.getElementById('presence-detail-list');
            if (warningEl) warningEl.remove();
            if (listEl) listEl.remove();

            // Clean up sync connections
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
                realtimeChannel = null;
            }
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            loadContracts();
        }

        function showContractEditor() {
            document.getElementById('contract-list').style.display = 'none';
            document.getElementById('contract-editor').style.display = 'block';

            // Show presence indicator in header
            const presenceIndicator = document.getElementById('presence-indicator');
            if (presenceIndicator) {
                presenceIndicator.style.display = 'flex';
            }
        }

        document.getElementById('back-to-list-btn').addEventListener('click', showContractList);

        // ============================================
        // CONTRACT LIST
        // ============================================

        async function loadContracts() {
            // Try to load contracts with shares, but fall back if shares table doesn't exist
            let { data, error } = await supabaseClient
                .from('contracts')
                .select(`
                    *,
                    contract_shares(
                        shared_with_email,
                        role
                    )
                `)
                .order('updated_at', { ascending: false });

            // If query failed (possibly because contract_shares doesn't exist yet), try without it
            if (error) {
                console.warn('Failed to load contracts with shares, trying without:', error);
                const result = await supabaseClient
                    .from('contracts')
                    .select('*')
                    .order('updated_at', { ascending: false });

                data = result.data;
                error = result.error;
            }

            if (error) {
                console.error('Error loading contracts:', error);
                alert('Failed to load contracts. Make sure you ran the database schema script.');
                return;
            }

            renderContractList(data || []);
        }

        function renderContractList(contracts) {
            const grid = document.getElementById('contracts-grid');

            if (contracts.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <h3 style="color: var(--accent-pink); margin-bottom: 20px; font-family: 'Cinzel', serif;">
                            No contracts yet
                        </h3>
                        <p style="color: var(--accent-light-pink); margin-bottom: 30px;">
                            Create your first dynamic contract to get started
                        </p>
                        <button class="btn" onclick="createNewContract()">+ Create Contract</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = contracts.map(contract => {
                const isShared = contract.contract_shares && contract.contract_shares.length > 0;
                const updatedDate = new Date(contract.updated_at).toLocaleDateString();

                return `
                    <div class="contract-card" onclick="openContract('${contract.id}')">
                        ${isShared ? '<span class="shared-badge">Shared</span>' : ''}
                        <h3>${contract.title || 'Untitled Contract'}</h3>
                        <div class="meta">
                            Last updated: ${updatedDate}
                            ${isShared ? `<br>Shared with ${contract.contract_shares.length} partner(s)` : ''}
                        </div>
                        <div class="actions">
                            <button class="btn" onclick="event.stopPropagation(); openContract('${contract.id}')">Open</button>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); deleteContract('${contract.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.createNewContract = async function() {
            const { data, error } = await supabaseClient
                .from('contracts')
                .insert({
                    user_id: currentUser.id,
                    title: 'New Contract',
                    data: { sections: [] }
                })
                .select()
                .single();

            if (error) {
                console.error('Error creating contract:', error);
                alert('Failed to create contract');
                return;
            }

            openContract(data.id);
        };

        document.getElementById('create-contract-btn').addEventListener('click', createNewContract);

        window.openContract = async function(contractId) {
            const { data, error } = await supabaseClient
                .from('contracts')
                .select('*')
                .eq('id', contractId)
                .single();

            if (error) {
                console.error('Error loading contract:', error);
                alert('Failed to load contract');
                return;
            }

            currentContract = data;

            // Load signatures into form
            document.getElementById('owner-signature').value = currentContract.owner_signature || '';
            document.getElementById('owner-signature-date').value = currentContract.owner_signature_date || '';
            document.getElementById('submissive-signature').value = currentContract.submissive_signature || '';
            document.getElementById('submissive-signature-date').value = currentContract.submissive_signature_date || '';

            renderContractEditor();
            setupRealtimeSync();
            setupPresence(); // Setup presence when opening contract
            showContractEditor();
        };

        window.deleteContract = async function(contractId) {
            if (!confirm('Are you sure you want to delete this contract?')) {
                return;
            }

            const { error } = await supabaseClient
                .from('contracts')
                .delete()
                .eq('id', contractId);

            if (error) {
                console.error('Error deleting contract:', error);
                alert('Failed to delete contract');
                return;
            }

            loadContracts();
        };

        // ============================================
        // CONTRACT EDITOR
        // ============================================

        function renderContractEditor() {
            document.getElementById('contract-title').value = currentContract.title || '';

            const sectionsContainer = document.getElementById('contract-sections');
            const sections = currentContract.data?.sections || [];

            if (sections.length === 0) {
                // Create default sections matching original template
                const defaultSections = [
                    {
                        type: 'parties',
                        title: 'Parties',
                        fields: [
                            { label: 'Dominant (Owner & Caregiver)', type: 'textarea', value: 'Matthew - Sir, Owner, Daddy' },
                            { label: 'Submissive (Little & Property)', type: 'textarea', value: 'Shailah - little girl, baby girl, princess, pet, toy, belonging' }
                        ]
                    },
                    {
                        type: 'commands',
                        title: 'Commands & Absolute Rules',
                        fields: [
                            { label: 'Command 1', type: 'textarea', value: 'The submissive must obey all commands immediately and without hesitation' },
                            { label: 'Command 2', type: 'textarea', value: 'The submissive belongs completely to the Dominant and exists for His pleasure' },
                            { label: 'Command 3', type: 'textarea', value: 'The submissive must always address the Dominant with respect and proper titles' }
                        ]
                    },
                    {
                        type: 'duties',
                        title: 'Required Duties & Service',
                        fields: [
                            { label: 'Daily Requirements', type: 'list', items: ['Morning greeting and check-in', 'Evening report of daily activities', 'Maintain personal presentation'] },
                            { label: 'Ongoing Expectations', type: 'list', items: ['Respectful communication at all times', 'Prompt responses to messages'] },
                            { label: 'Service Expectations', type: 'textarea', value: 'The submissive is expected to serve with devotion and eagerness, anticipating needs and seeking to please' }
                        ]
                    },
                    {
                        type: 'boundaries',
                        title: 'Boundaries',
                        fields: [
                            { label: 'Hard Limits (Absolute No)', type: 'list', items: ['Anything illegal', 'Permanent marks or modifications without consent', 'Involvement of others without prior discussion'] },
                            { label: 'Soft Limits (Requires Discussion)', type: 'list', items: ['Public display beyond agreed comfort levels', 'Extended time constraints'] },
                            { label: 'Safe Words & Signals', type: 'list', items: ['Red - Stop immediately', 'Yellow - Slow down/check in', 'Green - All is well'] }
                        ]
                    },
                    {
                        type: 'discipline',
                        title: 'Discipline & Correction',
                        fields: [
                            { label: 'Rewards for Obedience & Service', type: 'list', items: ['Praise and affection', 'Special privileges', 'Quality time and attention'] },
                            { label: 'Punishments for Disobedience & Failure', type: 'list', items: ['Loss of privileges', 'Corner time or reflection', 'Physical correction as appropriate'] }
                        ]
                    },
                    {
                        type: 'terms',
                        title: 'Terms of Ownership',
                        fields: [
                            { label: 'Effective Date', type: 'text', value: new Date().toISOString().split('T')[0] },
                            { label: 'Duration of Control', type: 'textarea', value: 'Ongoing and indefinite, subject to review at Dominant\'s discretion' },
                            { label: 'Review Schedule', type: 'textarea', value: 'Contract terms may be reviewed and modified by the Dominant as needed' },
                            { label: 'Release Clause', type: 'textarea', value: 'Either party may terminate this agreement with proper communication. The Dominant retains final authority over the terms of separation' }
                        ]
                    }
                ];

                currentContract.data = { sections: defaultSections };
                saveContract();
            }

            sectionsContainer.innerHTML = currentContract.data.sections.map((section, index) =>
                renderSection(section, index)
            ).join('');

            setupSectionListeners();
        }

        function renderSection(section, index) {
            return `
                <div class="contract-section" data-section-index="${index}">
                    <div class="section-header">
                        <h2 contenteditable="true" data-field="title">${section.title}</h2>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="addField(${index})">+ Add Field</button>
                            <button class="btn btn-secondary remove-btn" onclick="removeSection(${index})">Remove</button>
                        </div>
                    </div>
                    <div class="section-content" data-section-content="${index}">
                        ${section.fields.map((field, fieldIndex) => renderField(field, index, fieldIndex)).join('')}
                    </div>
                </div>
            `;
        }

        function renderField(field, sectionIndex, fieldIndex) {
            const fieldTypes = {
                text: (f) => `<input type="text" value="${f.value || ''}" data-field-value>`,
                textarea: (f) => `<textarea data-field-value>${f.value || ''}</textarea>`,
                list: (f) => `
                    <div class="list-container">
                        ${(f.items || []).map((item, itemIndex) => `
                            <div class="list-item" draggable="true" data-item-index="${itemIndex}">
                                <span class="drag-handle">🎀</span>
                                <input type="text" value="${item || ''}" data-item-index="${itemIndex}">
                                <button class="remove-btn" onclick="removeListItem(${sectionIndex}, ${fieldIndex}, ${itemIndex})">✕</button>
                            </div>
                        `).join('')}
                        <button class="add-item-btn" onclick="addListItem(${sectionIndex}, ${fieldIndex})">+ Add Item</button>
                    </div>
                `
            };

            const fieldType = field.type || 'textarea';
            const renderFunc = fieldTypes[fieldType] || fieldTypes.textarea;

            // For list fields, don't show the parent field bow or make it draggable
            if (fieldType === 'list') {
                return `
                    <div class="field-group field-group-list" data-field-index="${fieldIndex}">
                        <label contenteditable="true" data-field-label>${field.label || 'Field'}</label>
                        ${renderFunc(field)}
                        <button class="remove-btn" onclick="removeField(${sectionIndex}, ${fieldIndex})" style="margin-top: 10px;">Remove Field</button>
                    </div>
                `;
            }

            // For non-list fields, show bow and make draggable
            return `
                <div class="field-group" data-field-index="${fieldIndex}" draggable="true">
                    <span class="drag-handle">🎀</span>
                    <label contenteditable="true" data-field-label>${field.label || 'Field'}</label>
                    ${renderFunc(field)}
                    <button class="remove-btn" onclick="removeField(${sectionIndex}, ${fieldIndex})" style="margin-top: 10px;">Remove Field</button>
                </div>
            `;
        }

        // Field management functions
        window.addField = function(sectionIndex) {
            collectFormData(); // Capture any unsaved changes first
            const sections = currentContract.data.sections;
            sections[sectionIndex].fields.push({
                label: 'New Field',
                type: 'textarea',
                value: ''
            });
            saveContract();
            renderContractEditor();
        };

        window.removeField = function(sectionIndex, fieldIndex) {
            collectFormData(); // Capture any unsaved changes first
            const sections = currentContract.data.sections;
            sections[sectionIndex].fields.splice(fieldIndex, 1);
            saveContract();
            renderContractEditor();
        };

        window.addListItem = function(sectionIndex, fieldIndex) {
            collectFormData(); // Capture any unsaved changes first
            const sections = currentContract.data.sections;
            const field = sections[sectionIndex].fields[fieldIndex];
            if (!field.items) field.items = [];
            field.items.push('');
            saveContract();
            renderContractEditor();
        };

        window.removeListItem = function(sectionIndex, fieldIndex, itemIndex) {
            collectFormData(); // Capture any unsaved changes first
            const sections = currentContract.data.sections;
            const field = sections[sectionIndex].fields[fieldIndex];
            field.items.splice(itemIndex, 1);
            saveContract();
            renderContractEditor();
        };

        window.removeSection = function(sectionIndex) {
            if (!confirm('Remove this section?')) return;
            collectFormData(); // Capture any unsaved changes first
            currentContract.data.sections.splice(sectionIndex, 1);
            saveContract();
            renderContractEditor();
        };

        document.getElementById('add-section-btn').addEventListener('click', () => {
            collectFormData(); // Capture any unsaved changes first
            currentContract.data.sections.push({
                type: 'custom',
                title: 'New Section',
                fields: []
            });
            saveContract();
            renderContractEditor();
        });

        // Setup input listeners for auto-save
        function setupSectionListeners() {
            const editor = document.getElementById('contract-sections');

            editor.addEventListener('input', (e) => {
                const target = e.target;

                if (target.hasAttribute('contenteditable')) {
                    // Handle contenteditable fields (titles, labels)
                    debouncedSave();
                } else if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
                    // Handle regular input fields
                    debouncedSave();
                }
            });

            // Setup drag-and-drop for fields
            setupFieldDragDrop();
            // Setup drag-and-drop for list items
            setupListItemDragDrop();
        }

        // Drag and drop for fields
        let draggedFieldElement = null;
        let draggedFieldSectionIndex = null;

        function setupFieldDragDrop() {
            const editor = document.getElementById('contract-sections');

            editor.addEventListener('dragstart', (e) => {
                const fieldGroup = e.target.closest('.field-group');
                if (fieldGroup && e.target.classList.contains('drag-handle')) {
                    e.preventDefault();
                    return;
                }

                if (fieldGroup) {
                    draggedFieldElement = fieldGroup;
                    const section = fieldGroup.closest('.contract-section');
                    draggedFieldSectionIndex = parseInt(section.dataset.sectionIndex);
                    fieldGroup.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            editor.addEventListener('dragend', (e) => {
                const fieldGroup = e.target.closest('.field-group');
                if (fieldGroup) {
                    fieldGroup.classList.remove('dragging');
                    draggedFieldElement = null;
                    draggedFieldSectionIndex = null;
                }
            });

            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                const fieldGroup = e.target.closest('.field-group');
                if (!fieldGroup || fieldGroup === draggedFieldElement) return;

                const section = fieldGroup.closest('.contract-section');
                const sectionIndex = parseInt(section.dataset.sectionIndex);

                // Only allow dragging within same section
                if (sectionIndex !== draggedFieldSectionIndex) return;

                const rect = fieldGroup.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (e.clientY < midpoint) {
                    fieldGroup.parentNode.insertBefore(draggedFieldElement, fieldGroup);
                } else {
                    fieldGroup.parentNode.insertBefore(draggedFieldElement, fieldGroup.nextSibling);
                }
            });

            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedFieldElement) return;

                // Collect the new order and save
                collectFormData();
                saveContract();
            });
        }

        // Drag and drop for list items
        let draggedListItem = null;
        let draggedListContainer = null;

        function setupListItemDragDrop() {
            const editor = document.getElementById('contract-sections');

            editor.addEventListener('dragstart', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem) {
                    // Don't drag if clicking the drag handle itself
                    if (e.target.classList.contains('drag-handle')) {
                        e.preventDefault();
                        return;
                    }

                    draggedListItem = listItem;
                    draggedListContainer = listItem.closest('.list-container');
                    listItem.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            editor.addEventListener('dragend', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem) {
                    listItem.classList.remove('dragging');
                    draggedListItem = null;
                    draggedListContainer = null;
                }
            });

            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                const listItem = e.target.closest('.list-item');
                if (!listItem || listItem === draggedListItem) return;

                const container = listItem.closest('.list-container');
                if (container !== draggedListContainer) return; // Only within same list

                const rect = listItem.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (e.clientY < midpoint) {
                    listItem.parentNode.insertBefore(draggedListItem, listItem);
                } else {
                    listItem.parentNode.insertBefore(draggedListItem, listItem.nextSibling);
                }
            });

            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedListItem) return;

                // Collect the new order and save
                collectFormData();
                saveContract();
            });
        }

        document.getElementById('contract-title').addEventListener('input', (e) => {
            currentContract.title = e.target.value;
            debouncedSave();
        });

        // Signature field event listeners
        ['owner-signature', 'owner-signature-date', 'submissive-signature', 'submissive-signature-date'].forEach(id => {
            document.getElementById(id).addEventListener('input', debouncedSave);
        });

        // Debounced save function
        function debouncedSave() {
            clearTimeout(saveTimeout);
            updateSyncStatus('syncing');

            saveTimeout = setTimeout(() => {
                collectFormData();
                saveContract();
            }, 500);
        }

        // Collect form data from DOM
        function collectFormData() {
            const sections = [];
            document.querySelectorAll('.contract-section').forEach(sectionEl => {
                const sectionIndex = parseInt(sectionEl.dataset.sectionIndex);
                const section = currentContract.data.sections[sectionIndex];

                // Safety check: skip if section doesn't exist
                if (!section) return;

                // Update section title
                const titleEl = sectionEl.querySelector('[data-field="title"]');
                if (titleEl) {
                    section.title = titleEl.textContent;
                }

                // Update fields
                sectionEl.querySelectorAll('.field-group').forEach(fieldEl => {
                    const fieldIndex = parseInt(fieldEl.dataset.fieldIndex);
                    const field = section.fields[fieldIndex];

                    // Safety check: skip if field doesn't exist
                    if (!field) return;

                    // Update label
                    const labelEl = fieldEl.querySelector('[data-field-label]');
                    if (labelEl) {
                        field.label = labelEl.textContent;
                    }

                    // Update value
                    const valueEl = fieldEl.querySelector('[data-field-value]');
                    if (valueEl) {
                        field.value = valueEl.value;
                    }

                    // Update list items - only select input elements to avoid selecting parent divs
                    const listItems = fieldEl.querySelectorAll('input[data-item-index]');
                    if (listItems.length > 0) {
                        // Replace the array entirely to avoid stale items
                        field.items = Array.from(listItems).map(item => item.value);
                    } else if (field.type === 'list') {
                        // If it's a list field but has no items, ensure it's an empty array
                        field.items = [];
                    }
                });

                sections.push(section);
            });

            currentContract.data.sections = sections;
        }

        // Save contract to database
        async function saveContract() {
            if (isSyncing) return;
            isSyncing = true;

            // Collect signature data
            const ownerSig = document.getElementById('owner-signature')?.value || '';
            const ownerDate = document.getElementById('owner-signature-date')?.value || null;
            const subSig = document.getElementById('submissive-signature')?.value || '';
            const subDate = document.getElementById('submissive-signature-date')?.value || null;

            const { error } = await supabaseClient
                .from('contracts')
                .update({
                    title: currentContract.title,
                    data: currentContract.data,
                    owner_signature: ownerSig,
                    owner_signature_date: ownerDate,
                    submissive_signature: subSig,
                    submissive_signature_date: subDate,
                    updated_at: new Date().toISOString()
                })
                .eq('id', currentContract.id);

            if (error) {
                console.error('Error saving contract:', error);
                updateSyncStatus('error');
            } else {
                // Update local copy with signatures
                currentContract.owner_signature = ownerSig;
                currentContract.owner_signature_date = ownerDate;
                currentContract.submissive_signature = subSig;
                currentContract.submissive_signature_date = subDate;

                updateSyncStatus('synced');
                // Track change in history
                await trackChange('updated', 'Contract saved');
            }

            isSyncing = false;
        }

        // ============================================
        // REALTIME SYNC
        // ============================================

        function setupRealtimeSync() {
            // Clean up existing connections
            if (realtimeChannel) {
                supabaseClient.removeChannel(realtimeChannel);
            }
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }

            // Try Realtime first (WebSocket-based)
            realtimeChannel = supabaseClient
                .channel(`contract:${currentContract.id}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'contracts',
                        filter: `id=eq.${currentContract.id}`
                    },
                    handleRealtimeUpdate
                )
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('✅ Realtime sync enabled (WebSocket)');
                        usePolling = false;
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        console.log('⚠️ Realtime not available, using polling fallback');
                        usePolling = true;
                        setupPollingSync();
                    }
                });

            // Also start polling as a backup (will check usePolling flag)
            setTimeout(() => {
                if (!realtimeChannel || realtimeChannel.state !== 'joined') {
                    console.log('⚠️ Realtime failed to connect, using polling fallback');
                    usePolling = true;
                    setupPollingSync();
                }
            }, 3000); // Wait 3 seconds for realtime to connect
        }

        function setupPollingSync() {
            if (pollingInterval) return; // Already polling

            // Poll every 3 seconds for changes
            pollingInterval = setInterval(async () => {
                if (isSyncing) return; // Don't poll while we're saving

                try {
                    const { data, error } = await supabaseClient
                        .from('contracts')
                        .select('*')
                        .eq('id', currentContract.id)
                        .single();

                    if (error) {
                        console.error('Polling error:', error);
                        return;
                    }

                    // Check if data changed
                    if (data && JSON.stringify(data.data) !== JSON.stringify(currentContract.data)) {
                        console.log('📥 Polling detected changes');
                        currentContract = data;
                        renderContractEditor();
                        updateSyncStatus('synced');
                    }
                } catch (err) {
                    console.error('Polling failed:', err);
                }
            }, 3000); // Poll every 3 seconds

            console.log('🔄 Polling sync active (checking every 3 seconds)');
        }

        function handleRealtimeUpdate(payload) {
            if (isSyncing) return; // Don't update if we're the one saving

            const newData = payload.new;

            // Check if data actually changed
            if (JSON.stringify(newData.data) !== JSON.stringify(currentContract.data)) {
                currentContract = newData;
                renderContractEditor();
                updateSyncStatus('synced');
            }
        }

        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');

            dot.className = 'sync-dot';

            switch (status) {
                case 'syncing':
                    dot.classList.add('syncing');
                    text.textContent = 'Syncing...';
                    break;
                case 'synced':
                    text.textContent = 'Synced';
                    break;
                case 'error':
                    dot.classList.add('error');
                    text.textContent = 'Error';
                    break;
            }
        }

        // ============================================
        // PRESENCE (Who's Online)
        // ============================================

        function setupPresence() {
            if (presenceChannel) {
                supabaseClient.removeChannel(presenceChannel);
            }

            // Determine user's role in this contract
            const isEditor = currentUser.isPublicEditor ||
                            currentContract.user_id === currentUser.id ||
                            currentContract.public_share_role === 'editor';

            presenceChannel = supabaseClient.channel(`presence-${currentContract.id}`)
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    updatePresenceUI(state);
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    console.log('User joined:', newPresences);
                    showJoinNotification(newPresences[0]);
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    console.log('User left:', leftPresences);
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({
                            user: currentUser.email,
                            mode: isEditor ? 'editing' : 'viewing',
                            isPublicUser: currentUser.isPublicEditor || false,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        function updatePresenceUI(state) {
            const users = Object.values(state).flat();
            const currentUserEmail = currentUser.email;
            const otherUsers = users.filter(u => u.user !== currentUserEmail);

            // Count editors and viewers
            const editors = users.filter(u => u.mode === 'editing');
            const viewers = users.filter(u => u.mode === 'viewing');
            const otherEditors = editors.filter(u => u.user !== currentUserEmail);

            // Build presence text
            let presenceText;
            if (otherUsers.length === 0) {
                presenceText = 'You are online';
            } else {
                const parts = [];
                if (otherEditors.length > 0) {
                    parts.push(`${otherEditors.length} editing`);
                }
                if (viewers.length > 0) {
                    parts.push(`${viewers.length} viewing`);
                }
                presenceText = `${users.length} online: ${parts.join(', ')}`;
            }

            // Update presence indicator (for editors)
            const text = document.getElementById('presence-text');
            if (text) text.textContent = presenceText;

            // Update preview presence indicator (for viewers)
            const previewText = document.getElementById('preview-presence-text');
            if (previewText) previewText.textContent = presenceText;

            // Show warning if multiple editors (for both editors and viewers)
            showMultiEditorWarning(otherEditors);

            // Update detailed presence list (for both editors and viewers)
            updatePresenceList(users);
        }

        function showMultiEditorWarning(otherEditors) {
            let warningEl = document.getElementById('multi-editor-warning');

            // Show warning to everyone (both editors and viewers) when multiple editors are active
            if (otherEditors.length > 0) {
                if (!warningEl) {
                    warningEl = document.createElement('div');
                    warningEl.id = 'multi-editor-warning';
                    warningEl.style.cssText = `
                        position: fixed;
                        top: 70px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, #dc143c, #ff1744);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(220, 20, 60, 0.4);
                        z-index: 9999;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        animation: slideDown 0.3s ease-out;
                        max-width: 90%;
                        flex-wrap: wrap;
                        justify-content: center;
                    `;
                    document.body.appendChild(warningEl);
                }

                const editorNames = otherEditors.map(e => {
                    if (e.isPublicUser) return 'Public User';
                    return e.user.split('@')[0];
                }).join(', ');

                const isViewer = currentUser.isPublicViewer || currentUser.mode === 'viewing';
                const message = isViewer
                    ? `${otherEditors.length} ${otherEditors.length === 1 ? 'person is' : 'people are'} editing: ${editorNames}`
                    : `${otherEditors.length} other ${otherEditors.length === 1 ? 'person is' : 'people are'} editing: ${editorNames}`;

                warningEl.innerHTML = `
                    <span style="font-size: 20px;">⚠️</span>
                    <span>${message}</span>
                    <span style="font-size: 16px;">💾</span>
                    <span style="font-size: 0.9em; opacity: 0.9;">Changes save automatically</span>
                `;
            } else if (warningEl) {
                warningEl.remove();
            }
        }

        function updatePresenceList(users) {
            let listEl = document.getElementById('presence-detail-list');

            if (!listEl) {
                listEl = document.createElement('div');
                listEl.id = 'presence-detail-list';
                listEl.style.cssText = `
                    position: fixed;
                    top: 140px;
                    right: 20px;
                    background: rgba(20, 10, 10, 0.95);
                    border: 2px solid var(--accent-pink);
                    border-radius: 8px;
                    padding: 15px;
                    max-width: 250px;
                    z-index: 9998;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                `;
                document.body.appendChild(listEl);
            }

            const currentUserEmail = currentUser.email;
            const html = `
                <div style="font-size: 14px; font-weight: 600; color: var(--accent-pink); margin-bottom: 10px;">
                    👥 ${users.length} Online
                </div>
                ${users.map(u => {
                    const isYou = u.user === currentUserEmail;
                    const name = u.isPublicUser ? 'Public User' : u.user.split('@')[0];
                    const modeIcon = u.mode === 'editing' ? '✏️' : '👁️';
                    const modeText = u.mode === 'editing' ? 'Editing' : 'Viewing';
                    const modeColor = u.mode === 'editing' ? '#ff6b9d' : '#d4768f';

                    return `
                        <div style="
                            padding: 8px;
                            margin: 5px 0;
                            background: rgba(0, 0, 0, 0.3);
                            border-radius: 4px;
                            border-left: 3px solid ${modeColor};
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #ffb6c1; font-weight: ${isYou ? '700' : '400'};">
                                    ${name}${isYou ? ' (You)' : ''}
                                </span>
                                <span style="font-size: 16px;">${modeIcon}</span>
                            </div>
                            <div style="font-size: 11px; color: ${modeColor}; margin-top: 2px;">
                                ${modeText}
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            listEl.innerHTML = html;
        }

        function showJoinNotification(user) {
            const name = user.isPublicUser ? 'A public user' : user.user.split('@')[0];
            const mode = user.mode === 'editing' ? 'editing' : 'viewing';
            const icon = user.mode === 'editing' ? '✏️' : '👁️';

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, rgba(139, 0, 0, 0.95), rgba(220, 20, 60, 0.95));
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                border: 1px solid var(--accent-pink);
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${icon}</span>
                    <div>
                        <div style="font-weight: 600;">${name} joined</div>
                        <div style="font-size: 12px; opacity: 0.9;">Now ${mode}</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============================================
        // HISTORY TRACKING
        // ============================================

        async function trackChange(changeType, description) {
            // Skip history tracking for public editors
            if (currentUser?.isPublicEditor) {
                return;
            }

            const { error } = await supabaseClient
                .from('history')
                .insert({
                    contract_id: currentContract.id,
                    user_id: currentUser.id,
                    change_type: changeType,
                    description: description,
                    snapshot: currentContract.data
                });

            if (error) {
                console.error('Error tracking change:', error);
            }
        }

        // ============================================
        // CONTRACT PREVIEW
        // ============================================

        document.getElementById('preview-btn').addEventListener('click', () => {
            collectFormData(); // Make sure we have latest data
            renderPreview();
            document.getElementById('preview-overlay').classList.add('open');
        });

        document.getElementById('close-preview-btn').addEventListener('click', () => {
            document.getElementById('preview-overlay').classList.remove('open');
        });

        function renderPreview() {
            const sections = currentContract.data?.sections || [];
            const title = currentContract.title || 'D/s Dynamic Contract';
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Extract party names from first section if available
            let domName = 'Matthew';
            let subName = 'Shailah';
            if (sections.length > 0 && sections[0].type === 'parties' && sections[0].fields) {
                const domField = sections[0].fields[0];
                const subField = sections[0].fields[1];
                if (domField && domField.value) {
                    const match = domField.value.match(/^([^-\n]+)/);
                    if (match) domName = match[1].trim();
                }
                if (subField && subField.value) {
                    const match = subField.value.match(/^([^-\n]+)/);
                    if (match) subName = match[1].trim();
                }
            }

            let html = `
                <div class="preview-bow preview-bow-top-left">🎀</div>
                <div class="preview-bow preview-bow-top-right">🎀</div>
                <div class="preview-bow preview-bow-bottom-left">🎀</div>
                <div class="preview-bow preview-bow-bottom-right">🎀</div>
                <h1>${escapeHtml(title)}</h1>
                <p class="preview-subtitle">Between Dom ${escapeHtml(domName)} and his sub ${escapeHtml(subName)}</p>

                <div class="preview-terms-notice">
                    This contract establishes a Total Power Exchange (TPE) dynamic where the submissive willingly surrenders complete control and authority to the Dominant. The submissive acknowledges the Dominant's absolute authority in all matters and agrees to obey without question. All activities remain bound by established safe words and hard limits. Either party may terminate this agreement, though renegotiation requires the Dominant's approval.
                </div>
            `;

            sections.forEach((section, index) => {
                if (!section.title) return;

                // Add decorative divider before each section (except first)
                if (index > 0) {
                    html += `<div class="preview-divider">⛓️ 🎀 ⛓️</div>`;
                }

                html += `<h2>${escapeHtml(section.title)}</h2>`;

                if (!section.fields || section.fields.length === 0) {
                    html += `<p class="preview-empty">[No content yet]</p>`;
                    return;
                }

                section.fields.forEach(field => {
                    if (!field || (!field.label && !field.value)) return;

                    html += `<h3>${escapeHtml(field.label || 'Field')}</h3>`;

                    if (field.type === 'list' && field.items && Array.isArray(field.items) && field.items.length > 0) {
                        html += '<ul>';
                        field.items.forEach(item => {
                            // Safety check: ensure item exists and is a string
                            if (item && typeof item === 'string' && item.trim()) {
                                html += `<li>${escapeHtml(item)}</li>`;
                            }
                        });
                        html += '</ul>';
                    } else if (field.value && typeof field.value === 'string' && field.value.trim()) {
                        // Convert newlines to paragraphs
                        const paragraphs = field.value.split('\n').filter(p => p.trim());
                        paragraphs.forEach(para => {
                            html += `<p>${escapeHtml(para)}</p>`;
                        });
                    } else {
                        html += `<p class="preview-empty">[Not specified]</p>`;
                    }
                });
            });

            // Add signature section matching index.html exactly
            const ownerSig = currentContract.owner_signature || '';
            const ownerDate = currentContract.owner_signature_date || '';
            const subSig = currentContract.submissive_signature || '';
            const subDate = currentContract.submissive_signature_date || '';

            const ownerDateFormatted = ownerDate ? new Date(ownerDate).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '';
            const subDateFormatted = subDate ? new Date(subDate).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '';

            html += `
                <div class="preview-signature-section">
                    <div class="preview-signature-box">
                        <label>Owner's Signature</label>
                        <div class="preview-signature-value">${escapeHtml(ownerSig)}</div>
                        <div class="preview-signature-date">${ownerDateFormatted}</div>
                    </div>
                    <div class="preview-signature-box">
                        <label>Submissive's Acceptance</label>
                        <div class="preview-signature-value">${escapeHtml(subSig)}</div>
                        <div class="preview-signature-date">${subDateFormatted}</div>
                    </div>
                </div>
            `;

            html += `<div class="preview-divider" style="margin-top: 50px;">⛓️ 🎀 ⛓️</div>`;
            html += `<div class="preview-date">Contract date: ${date}</div>`;

            document.getElementById('preview-content').innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // HISTORY TRACKING
        // ============================================

        document.getElementById('history-btn').addEventListener('click', async () => {
            document.getElementById('history-panel').classList.add('open');
            await loadHistory();
        });

        document.getElementById('close-history-btn').addEventListener('click', () => {
            document.getElementById('history-panel').classList.remove('open');
        });

        async function loadHistory() {
            const { data, error } = await supabaseClient
                .from('history')
                .select('*')
                .eq('contract_id', currentContract.id)
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                console.error('Error loading history:', error);
                return;
            }

            renderHistory(data);
        }

        function renderHistory(items) {
            const timeline = document.getElementById('history-timeline');

            if (items.length === 0) {
                timeline.innerHTML = '<p style="color: var(--accent-light-pink); text-align: center;">No history yet</p>';
                return;
            }

            timeline.innerHTML = items.map(item => {
                const date = new Date(item.created_at);
                const timeStr = date.toLocaleString();

                return `
                    <div class="history-item">
                        <div class="timestamp">${timeStr}</div>
                        <div class="change">
                            <span class="user">${item.user_id}</span> ${item.description}
                        </div>
                        ${item.is_snapshot ? '<button class="btn btn-secondary" style="margin-top: 10px;" onclick="restoreSnapshot(\'' + item.id + '\')">Restore</button>' : ''}
                    </div>
                `;
            }).join('');
        }

        document.getElementById('save-snapshot-btn').addEventListener('click', async () => {
            const description = prompt('Snapshot description:');
            if (!description) return;

            const { error } = await supabaseClient
                .from('history')
                .insert({
                    contract_id: currentContract.id,
                    user_id: currentUser.id,
                    change_type: 'snapshot',
                    description: `Snapshot: ${description}`,
                    snapshot: currentContract.data,
                    is_snapshot: true
                });

            if (error) {
                console.error('Error creating snapshot:', error);
                alert('Failed to create snapshot');
            } else {
                alert('Snapshot created!');
            }
        });

        window.restoreSnapshot = async function(historyId) {
            if (!confirm('Restore this version? Current changes will be saved as a snapshot.')) {
                return;
            }

            // Save current state as snapshot first
            await supabaseClient.from('history').insert({
                contract_id: currentContract.id,
                user_id: currentUser.id,
                change_type: 'snapshot',
                description: 'Auto-snapshot before restore',
                snapshot: currentContract.data,
                is_snapshot: true
            });

            // Load the snapshot
            const { data, error } = await supabaseClient
                .from('history')
                .select('snapshot')
                .eq('id', historyId)
                .single();

            if (error) {
                console.error('Error loading snapshot:', error);
                alert('Failed to restore snapshot');
                return;
            }

            // Restore the data
            currentContract.data = data.snapshot;
            await saveContract();
            renderContractEditor();
            alert('Snapshot restored!');
        };

        // ============================================
        // SHARING
        // ============================================

        document.getElementById('share-btn').addEventListener('click', async () => {
            document.getElementById('share-dialog').classList.add('open');
            await loadShares();
            await loadPublicShareStatus();
        });

        document.getElementById('cancel-share-btn').addEventListener('click', () => {
            document.getElementById('share-dialog').classList.remove('open');
        });

        document.getElementById('confirm-share-btn').addEventListener('click', async () => {
            const email = document.getElementById('share-email').value;
            const role = document.getElementById('share-role').value;

            if (!email) {
                alert('Please enter an email');
                return;
            }

            const { error } = await supabaseClient
                .from('contract_shares')
                .insert({
                    contract_id: currentContract.id,
                    shared_with_email: email,
                    role: role
                });

            if (error) {
                console.error('Error sharing contract:', error);
                alert('Failed to share contract');
                return;
            }

            document.getElementById('share-email').value = '';
            await loadShares();
            alert('Contract shared!');
        });

        async function loadShares() {
            const { data, error } = await supabaseClient
                .from('contract_shares')
                .select('*')
                .eq('contract_id', currentContract.id);

            if (error) {
                console.error('Error loading shares:', error);
                return;
            }

            const listEl = document.getElementById('shares-list');

            if (data.length === 0) {
                listEl.innerHTML = '<p style="color: var(--accent-light-pink);">Not shared yet</p>';
                return;
            }

            listEl.innerHTML = data.map(share => `
                <div class="list-item" style="margin-bottom: 10px;">
                    <span>${share.shared_with_email} (${share.role})</span>
                    <button class="remove-btn" onclick="removeShare('${share.id}')">Remove</button>
                </div>
            `).join('');
        }

        window.removeShare = async function(shareId) {
            const { error } = await supabaseClient
                .from('contract_shares')
                .delete()
                .eq('id', shareId);

            if (error) {
                console.error('Error removing share:', error);
                alert('Failed to remove share');
                return;
            }

            await loadShares();
        };

        // ============================================
        // PUBLIC SHARING
        // ============================================

        async function loadPublicShareStatus() {
            const isPublic = currentContract.is_public || false;
            const toggle = document.getElementById('public-share-toggle');
            const container = document.getElementById('public-link-container');
            const linkInput = document.getElementById('public-link');
            const roleSelect = document.getElementById('public-share-role');

            toggle.checked = isPublic;

            if (isPublic && currentContract.public_share_token) {
                container.style.display = 'block';
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${currentContract.public_share_token}`;
                linkInput.value = shareUrl;
                roleSelect.value = currentContract.public_share_role || 'viewer';
            } else {
                container.style.display = 'none';
            }
        }

        document.getElementById('public-share-toggle').addEventListener('change', async (e) => {
            const isEnabled = e.target.checked;
            const role = document.getElementById('public-share-role').value;

            if (isEnabled && !currentContract.public_share_token) {
                // Generate new token
                const token = generateShareToken();
                currentContract.public_share_token = token;
            }

            currentContract.is_public = isEnabled;
            currentContract.public_share_role = role;

            // Update database
            const { error } = await supabaseClient
                .from('contracts')
                .update({
                    is_public: isEnabled,
                    public_share_token: currentContract.public_share_token,
                    public_share_role: role
                })
                .eq('id', currentContract.id);

            if (error) {
                console.error('Error updating public share:', error);
                alert('Failed to update public sharing');
                e.target.checked = !isEnabled; // Revert
                return;
            }

            await loadPublicShareStatus();
        });

        // Update role when changed
        document.getElementById('public-share-role').addEventListener('change', async (e) => {
            const role = e.target.value;
            currentContract.public_share_role = role;

            const { error } = await supabaseClient
                .from('contracts')
                .update({ public_share_role: role })
                .eq('id', currentContract.id);

            if (error) {
                console.error('Error updating public share role:', error);
            }
        });

        document.getElementById('copy-link-btn').addEventListener('click', () => {
            const linkInput = document.getElementById('public-link');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value);

            const btn = document.getElementById('copy-link-btn');
            const originalText = btn.textContent;
            btn.textContent = '✓ Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        });

        function generateShareToken() {
            // Generate a random 32-character token
            const array = new Uint8Array(24);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode(...array))
                .replace(/\//g, '_')
                .replace(/\+/g, '-')
                .replace(/=/g, '');
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        checkAuth();
    </script>
</body>
</html>